pipeline {
    agent none

    parameters {
        choice(
            name: 'ENV',
            choices: ['dev', 'prod'],
            description: '배포할 환경을 선택하세요'
        )
    }

    environment {
        // === Shared Credentials (dev/prod switch) ===
        JWT_SECRET           = credentials("JWT_SECRET_${ENV.toUpperCase()}")
        KAKAO_KEY            = credentials("KAKAO_KEY_${ENV.toUpperCase()}")
        NAVER_CLIENT_ID      = credentials("NAVER_CLIENT_ID_${ENV.toUpperCase()}")
        NAVER_CLIENT_SECRET  = credentials("NAVER_CLIENT_SECRET_${ENV.toUpperCase()}")

        KAKAO_REDIRECT_URI   = credentials("KAKAO_REDIRECT_URI_${ENV.toUpperCase()}")
        NAVER_REDIRECT_URI   = credentials("NAVER_REDIRECT_URI_${ENV.toUpperCase()}")

        // === Backend DB Credentials ===
        DB_HOST              = credentials("DB_HOST_${ENV.toUpperCase()}")
        DB_USER              = credentials("DB_USER_${ENV.toUpperCase()}")
        DB_PASS              = credentials("DB_PASS_${ENV.toUpperCase()}")
        DB_NAME              = credentials("DB_NAME_${ENV.toUpperCase()}")
    }

    stages {

        /* ---------------------------------------------------------
           1) Checkout
        --------------------------------------------------------- */
        stage('Checkout') {
            agent { label 'linux_02' }
            steps {
                checkout scm
            }
        }

        /* ---------------------------------------------------------
           2) Backend env 생성
        --------------------------------------------------------- */
        stage('Generate Backend env') {
            agent { label 'linux_02' }
            steps {
                sh """
                echo '[Backend] Generating .env...'

                cat config/.env.shared.template web/backend/.env.backend.template > web/backend/.env.temp

                sed -i 's|{{JWT_SECRET}}|${JWT_SECRET}|g' web/backend/.env.temp
                sed -i 's|{{KAKAO_KEY}}|${KAKAO_KEY}|g' web/backend/.env.temp
                sed -i 's|{{NAVER_CLIENT_ID}}|${NAVER_CLIENT_ID}|g' web/backend/.env.temp
                sed -i 's|{{NAVER_CLIENT_SECRET}}|${NAVER_CLIENT_SECRET}|g' web/backend/.env.temp
                sed -i 's|{{KAKAO_REDIRECT_URI}}|${KAKAO_REDIRECT_URI}|g' web/backend/.env.temp
                sed -i 's|{{NAVER_REDIRECT_URI}}|${NAVER_REDIRECT_URI}|g' web/backend/.env.temp

                sed -i 's|{{DB_HOST}}|${DB_HOST}|g' web/backend/.env.temp
                sed -i 's|{{DB_USER}}|${DB_USER}|g' web/backend/.env.temp
                sed -i 's|{{DB_PASS}}|${DB_PASS}|g' web/backend/.env.temp
                sed -i 's|{{DB_NAME}}|${DB_NAME}|g' web/backend/.env.temp

                mv web/backend/.env.temp web/backend/.env
                """
            }
        }


        /* ---------------------------------------------------------
           3) Frontend env 생성
        --------------------------------------------------------- */
        stage('Generate Frontend env') {
            agent { label 'linux_02' }
            steps {
                sh """
                echo '[Frontend] Generating .env...'

                cat config/.env.shared.template web/frontend/.env.frontend.template > web/frontend/.env.temp

                sed -i 's|{{JWT_SECRET}}|${JWT_SECRET}|g' web/frontend/.env.temp
                sed -i 's|{{KAKAO_KEY}}|${KAKAO_KEY}|g' web/frontend/.env.temp
                sed -i 's|{{NAVER_CLIENT_ID}}|${NAVER_CLIENT_ID}|g' web/frontend/.env.temp

                sed -i 's|{{KAKAO_REDIRECT_URI}}|${KAKAO_REDIRECT_URI}|g' web/frontend/.env.temp
                sed -i 's|{{NAVER_REDIRECT_URI}}|${NAVER_REDIRECT_URI}|g' web/frontend/.env.temp

                mv web/frontend/.env.temp web/frontend/.env
                """
            }
        }

        /* ---------------------------------------------------------
           4) Linux Deploy
        --------------------------------------------------------- */
        stage('Deploy (Linux)') {
            agent { label 'linux_02' }
            steps {
                sh """
                chmod +x /home/ubuntu/todolist_app/deploy/deploy.sh
                yes | /home/ubuntu/todolist_app/deploy/deploy.sh
                """
            }
        }

        /* ---------------------------------------------------------
           5) Windows Deploy
        --------------------------------------------------------- */
        stage('Deploy (Windows)') {
            agent { label 'windows_01' }
            steps {
                bat """
                echo Windows deploy...
                cd C:\\Automation\\todolist_app\\deploy
                echo y | deploy.bat
                """
            }
        }

        /* ---------------------------------------------------------
           6) Trigger Test Repo Job
        --------------------------------------------------------- */
        stage('Trigger Test Pipeline') {
            agent { label 'linux_02' }
            steps {
                build job: 'todolist_test',
                      parameters: [
                          string(name: 'ENV', value: params.ENV)
                      ],
                      wait: false
            }
        }
    }

    post {
        success { echo "✅ ${params.ENV.toUpperCase()} 배포 완료 + 테스트 Pipeline 실행됨" }
        failure { echo "❌ 배포 실패" }
    }
}
